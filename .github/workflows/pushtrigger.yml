name: VIDAI Backend Pushtrigger

on:
  push:
    branches:
      - main
      - devops-build

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # ---------------- Checkout Code ----------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # ---------------- Setup Docker ----------------
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # ---------------- Login DockerHub ----------------
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # ---------------- Build Backend Image ----------------
    - name: Build Docker image
      run: |
        docker build \
          -f devops/Dockerfile \
          -t ${{ secrets.DOCKER_USERNAME }}/vidai-backend:latest \
          .

    # ---------------- Verify Image ----------------
    - name: Verify image exists
      run: docker images

    # ---------------- Save Image (IMPORTANT FIX) ----------------
    - name: Save Docker image
      run: |
        docker save ${{ secrets.DOCKER_USERNAME }}/vidai-backend:latest \
        -o ${{ github.workspace }}/backend.tar

    # ---------------- Copy Image to VPS ----------------
    - name: Copy image to VPS
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        source: "${{ github.workspace }}/backend.tar"
        target: "/root/"

    # ---------------- Deploy Container ----------------
    - name: Deploy backend container
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          echo "Loading Docker image..."
          docker load -i /root/backend.tar

          echo "Stopping old container..."
          docker stop vidai-backend || true
          docker rm vidai-backend || true

          echo "Starting new backend container..."
          docker run -d \
            --restart always \
            --name vidai-backend \
            -p 8004:8000 \
            --add-host=host.docker.internal:host-gateway \
            ${{ secrets.DOCKER_USERNAME }}/vidai-backend:latest

          echo "Cleaning temp file..."
          rm -f /root/backend.tar
