name: VIDAI Backend PUSHTRIGGER

on:
  push:
    branches:
      - main
      - devops-build

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:

    # ---------------- CHECKOUT ----------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # ---------------- DOCKER SETUP ----------------
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # ---------------- LOGIN DOCKER ----------------
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # ---------------- BUILD IMAGE ----------------
    - name: Build backend Docker image
      run: |
        docker build \
          -f devops/Dockerfile \
          -t ${{ secrets.DOCKER_USERNAME }}/vidai-backend:latest .

    # ---------------- SAVE IMAGE ----------------
    # (Saved INSIDE workspace â†’ avoids permission errors)
    - name: Save Docker image
      run: docker save ${{ secrets.DOCKER_USERNAME }}/vidai-backend:latest -o backend.tar

    # ---------------- VERIFY FILE EXISTS ----------------
    - name: Verify tar file
      run: ls -lh

    # ---------------- COPY IMAGE TO VPS ----------------
    - name: Copy image to VPS
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        source: "backend.tar"
        target: "/root/"

    # ---------------- DEPLOY CONTAINER ----------------
    - name: Deploy backend container
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          echo "Loading Docker image..."
          docker load -i /root/backend.tar

          echo "Stopping old container..."
          docker stop vidai-backend || true
          docker rm vidai-backend || true

          echo "Starting new backend container..."
          docker run -d \
            --restart always \
            --name vidai-backend \
            -p 8004:8000 \
            --add-host=host.docker.internal:host-gateway \
            ${{ secrets.DOCKER_USERNAME }}/vidai-backend:latest

          echo "Cleaning temp file..."
          rm -f /root/backend.tar
