name: VIDAI Backend PushTrigger

on:
  push:
    branches:
      - main
      - dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # ---------------- Checkout ----------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # ---------------- Docker setup ----------------
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # ---------------- Login DockerHub (only for tagging) ----------------
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # ---------------- Build backend image ----------------
    - name: Build Docker image
      run: |
        docker build \
          -f devops/Dockerfile \
          -t ${{ secrets.DOCKER_USERNAME }}/vidai-backend:latest \
          .

    # ---------------- Save image as file ----------------
    - name: Save Docker image
      run: |
        docker save ${{ secrets.DOCKER_USERNAME }}/vidai-backend:latest -o backend.tar

    # ---------------- Copy image to VPS ----------------
    - name: Copy image to VPS
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        source: "backend.tar"
        target: "/root/"

    # ---------------- Deploy on VPS ----------------
    - name: Deploy backend container
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          echo "Loading new Docker image..."
          docker load -i /root/backend.tar

          echo "Stopping old container..."
          docker stop vidai-backend || true
          docker rm vidai-backend || true

          echo "Starting new container..."
          docker run -d \
            --restart always \
            --name vidai-backend \
            -p 8004:8000 \
            --add-host=host.docker.internal:host-gateway \
            ${{ secrets.DOCKER_USERNAME }}/vidai-backend:latest

          echo "Cleaning temporary file..."
          rm -f /root/backend.tar
